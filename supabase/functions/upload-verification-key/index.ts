import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // The verification key data
    const verificationKey = {
      "protocol": "groth16",
      "curve": "bn128",
      "nPublic": 3,
      "vk_alpha_1": [
        "20491192805390485299153009773594534940189261866228447918068658471970481763042",
        "9383485363053290200918347156157836566562967994039712273449902621266178545958",
        "1"
      ],
      "vk_beta_2": [
        [
          "6375614351688725206403948262868962793625744043794305715222011528459656738731",
          "4252822878758300859123897981450591353533073413197771768651442665752259397132"
        ],
        [
          "10505242626370262277552901082094356697409835680220590971873171140371331206856",
          "21847035105528745403288232691147584728191162732299865338377159692350059136679"
        ],
        [
          "1",
          "0"
        ]
      ],
      "vk_gamma_2": [
        [
          "10857046999023057135944570762232829481370756359578518086990519993285655852781",
          "11559732032986387107991004021392285783925812861821192530917403151452391805634"
        ],
        [
          "8495653923123431417604973247489272438418190587263600148770280649306958101930",
          "4082367875863433681332203403145435568316851327593401208105741076214120093531"
        ],
        [
          "1",
          "0"
        ]
      ],
      "vk_delta_2": [
        [
          "296366766069659771291927525993374576305613664360037703181376121716650569354",
          "1786974114312222410753992655587072751002791169417746921640382718440378558676"
        ],
        [
          "17285507412740153755365035462661974970812887381355681904711233091862669875782",
          "1619994087337042045685051453919553873344947709459571230636654152141759600844"
        ],
        [
          "1",
          "0"
        ]
      ],
      "vk_alphabeta_12": [
        [
          [
            "2029413683389138792403550203267699914886160938906632433982220835551125967885",
            "21072700047562757817161031222997517981543347628379360635925549008442030252106"
          ],
          [
            "5940354580057074848093997050200682056184807770593307860589430076672439820312",
            "12156638873931618554171829126792193045421052652279363021382169897324752428276"
          ],
          [
            "7898200236362823042373859371574133993780991612861777490112507062703164551277",
            "7074218545237549455313236346927434013100842096812539264420499035217050630853"
          ]
        ],
        [
          [
            "7077479683546002997211712695946002074877511277312570035766170199895071832130",
            "10093483419865920389913245021038182291233451549023025229112148274109565435465"
          ],
          [
            "4595479056700221319381530156280926371456704509942304414423590385166031118820",
            "19831328484489333784475432780421641293929726139240675179672856274388269393268"
          ],
          [
            "11934129596455521040620786944827826205713621633706285934057045369193958244500",
            "8037395052364110730298837004334506829870972346962140206007064471173334027475"
          ]
        ]
      ],
      "IC": [
        [
          "3940584168037296810587025163758715994529783456944193731635785253815718138315",
          "5899322903340579846814483887734391299712067640821240363871664816877029444703",
          "1"
        ],
        [
          "15555350117516475107245599521271908626046146496357516014766441545890590067334",
          "10432210193452396772877268588009019753250323192009417886710735542624323033624",
          "1"
        ],
        [
          "18802716613936883490508000397771418997109976235752432688884176221560136714057",
          "4583852663092109916252710207163241721970201837341242312915462569433899110324",
          "1"
        ],
        [
          "15166323354504859257077992781358120200066268069600010565474527233021641208488",
          "1269005710950875610968465075460551915307571829139525183242087902980288982362",
          "1"
        ]
      ]
    };

    // Convert to blob and upload
    const blob = new Blob([JSON.stringify(verificationKey)], { type: 'application/json' });
    
    const { error: uploadError } = await supabase.storage
      .from('zkp')
      .upload('verification_key.json', blob, {
        contentType: 'application/json',
        upsert: true
      });

    if (uploadError) {
      console.error('Upload error:', uploadError);
      throw uploadError;
    }

    console.log('Verification key uploaded successfully');

    return new Response(
      JSON.stringify({ success: true, message: 'Verification key uploaded successfully' }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    console.error('Error in upload-verification-key:', error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : 'Unknown error' }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
